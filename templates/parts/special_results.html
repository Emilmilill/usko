
{% set answers_count = count_answers(0, event.id) %}

<script>
    var checked = new Set();
</script>

<div class="container text-center mb-4">
    <h3>Filter odpovedí</h3>

    <form>
    <div class="form-group ">
        <label for="select">1. Vyberte anketovú udalosť: </label>
        <select class="form-control mx-auto" id="select" style="width: 250px" onchange="location = this.value;">
          {% for event in events %}
              <option value="{{ event.name }}" {% if event_name == event.name %} selected {% endif %}>{{ event.name }}</option>
          {% endfor %}
        </select>
    </div>
    </form>

    <p>2. Vyberte triedy: </p>
    {% if filter_checkboxes|length == 0 %}
        <p style="color:red">V tejto anketovej udalosti nemáte žiadne odpovede od študentov.</p>
    {% endif %}
    {% for class in filter_checkboxes %}
        <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="filter" onchange="filterResults(this)"
               id="{{ class }}" value="{{ class }}" checked>
        <label class="form-check-label" for="{{ class }}"> {{ class }} </label>
        </div>
        <script>
            checked.add("{{ class }}");
        </script>
    {% endfor %}
    <!--<p>Počet odpovedí: {{ answers_count }}</p>-->
</div>

{% for category in categories %}

    <h4>{{ category.name }}</h4>

    {% for question in category.questions %}
        <h5>{{ question.description }}</h5>

        {% if question.type.name == "text" %}

            {% include "parts/result2_parts/text_answers.html" %}

        {% elif question.type.name == "radio" %}

            {% include "parts/result2_parts/radio_chart.html" %}


        {% elif question.type.name == "checkbox" %}

            {% include "parts/result2_parts/checkbox_chart.html" %}

        {% else %}

            <p>Unknown question type</p>

        {% endif %}

    {% endfor %}
{% endfor %}

{# JS for charts #}
<script>


    var radioChartOptions = {
        axisX: {
            showGrid: false
        },
        axisY: {
            onlyInteger: true
        },
        distributeSeries: true,
        high: {{ answers_count }}
    };

    var checkboxChartOptions = {
        axisX: {
            showGrid: false
        },
        axisY: {
            onlyInteger: true
        },
        stackBars: true
    };


    var labels = [];
    var series = [];
    var series1 = [];
    var series2 = [];


    var charts = [];
    var all_labels = {};
    var all_series = {};
    var text_answer_tables = {};

    {% for category in categories %}
        {% for question in category.questions %}
            {% if question.type.name == "radio" or question.type.name == "checkbox" %}
                all_labels[{{ question.id }}] = [];
                all_series[{{ question.id }}] = [];
                {% for option in question.options %}
                    all_labels[{{ question.id }}].push("{{ option.description }}");
                    all_series[{{ question.id }}].push({{ get_votes_for_class(option, question.id, event) | safe}});
                {% endfor %}
            {% elif question.type.name == "text" %}
                text_answer_tables["table{{ question.id }}"] = {{ text_answers4class(question.id, event) | safe}};
            {% endif %}
        {% endfor %}
    {% endfor %}


    function filterResults(checkBox) {
      if (checkBox.checked === true){
        checked.add(checkBox.value);
      } else {
        checked.delete(checkBox.value);
      }


      for (let i = 0; i < charts.length; i++) {
          let series = [];
          let chart_id = charts[i][0];
          let chart_series_src = all_series[chart_id];
          for (var j = 0; j < chart_series_src.length; j++) {
              series.push(chart_series_src[j].reduce(sumChecked, 0));
          }
          let data = {};
          if (charts[i][2] === "radio") {
              data = {labels:all_labels[chart_id], series:series};
          } else if (charts[i][2] === "checkbox") {
              series2 = series.map(x => {{ answers_count }} - x);
              data = {labels:all_labels[chart_id], series:[series, series2]};
          }
          charts[i][1].update(data);
       }

        for (const table_id in text_answer_tables) {
          $("#"+table_id+" tbody tr").remove();
          let table_answers = text_answer_tables[table_id];
          let table_body = document.getElementById(table_id).getElementsByTagName("tbody")[0];
          let k = 0;
          for (let j = 0; j < table_answers.length; j++) {
              if (checked.has(table_answers[j][0])) {
                  k++;
                  let row = table_body.insertRow(-1);
                  let cell1 = row.insertCell(0);
                  let cell2 = row.insertCell(1);
                  let cell3 = row.insertCell(2);
                  cell1.innerHTML = k;
                  cell2.innerHTML = table_answers[j][0]
                  cell3.innerHTML = table_answers[j][1];
              }
          }
        }
    }

    function sumChecked(total, pair) {
        if (checked.has(pair[0])) {
            return total + pair[1];
        }
        return total;
    }

</script>

{% for category in categories %}
    {% for question in category.questions %}
        {% if question.type.name == "radio" %}

            <script>

                labels = [];
                series = [];

                {% for option in question.options %}
                    labels.push("{{ option.description }} ({{ count_options(option, 0, question.id, event) }})");
                    series.push({{ count_options(option, 0, question.id, event) }});
                {% endfor %}

                var chart{{ question.id }} = new Chartist.Bar(
                    '#chart{{ question.id }}',
                    {
                        labels: labels,
                        series: series
                    }, radioChartOptions).on('draw', function(data) {
                      if(data.type === 'bar') {
                        data.element.attr({
                          style: 'stroke-width: 30px'
                        });
                      };
                    });
                charts.push(["{{ question.id }}", chart{{ question.id }}, "radio"]);
            </script>

        {% elif question.type.name == "checkbox" %}

            <script>
                labels = [];
                series1 = [];

                {% for option in question.options %}
                    labels.push("{{ option.description }} ({{ count_options(option, 0, question.id, event) }}/{{ answers_count }})");
                    series1.push({{ count_options(option, 0, question.id, event) }});
                {% endfor %}

                series2 = series1.map(x => {{ answers_count }} - x);

                var chart{{ question.id }} = new Chartist.Bar(
                    '#chart{{ question.id }}',
                    { labels: labels, series: [series1, series2] },
                    checkboxChartOptions
                ).on('draw', function(data) {
                  if(data.type === 'bar') {
                    data.element.attr({
                      style: 'stroke-width: 20px'
                    });
                  };
                });
                charts.push(["{{ question.id }}", chart{{ question.id }}, "checkbox"]);
            </script>

        {% endif %}

    {% endfor %}
{% endfor %}